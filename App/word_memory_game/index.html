<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Word Matcher</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --container-bg: #16213e;
            --accent-color: #0f3460;
            --highlight-color: #e94560;
            --text-color: #eaeaea;
            --correct-color: #4cd137;
            --wrong-color: #e84118;
            --timer-bg: #e94560;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        /* 공통 레이아웃 */
        .screen {
            display: none;
            width: 100%;
            max-width: 800px;
            height: 100vh; /* 모바일 대응 */
            max-height: 900px;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            text-align: center;
            position: relative;
            background-color: var(--container-bg);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        @media (min-width: 768px) {
            .screen {
                height: auto;
                min-height: 600px;
                border-radius: 15px;
            }
        }

        .active {
            display: flex;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 { margin-bottom: 2rem; font-size: 2.5rem; color: var(--highlight-color); text-transform: uppercase; letter-spacing: 2px; }
        h2 { margin-bottom: 1.5rem; color: var(--text-color); }

        /* 버튼 스타일 */
        .btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            width: 200px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .btn:hover { background-color: var(--highlight-color); transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        .btn-small { width: auto; padding: 10px 20px; font-size: 1rem; }
        .btn-secondary { background-color: #555; }

        /* 설정 및 입력 폼 */
        .form-group { margin-bottom: 20px; text-align: left; width: 100%; max-width: 400px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input[type="number"], .form-group input[type="file"] {
            width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #444; background: #222; color: white;
        }
        .slider-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        input[type="range"] { width: 70%; }

        /* 게임 화면 */
        #word-display {
            font-size: 3rem;
            font-weight: bold;
            margin: 30px 0;
            color: var(--highlight-color);
            min-height: 80px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            margin-bottom: 20px;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .option-btn {
            background-color: #2a2a40;
            border: 2px solid var(--accent-color);
            color: white;
            padding: 20px;
            font-size: 1.2rem;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.1s;
            position: relative;
        }

        .option-btn:hover { background-color: var(--accent-color); }
        .option-btn .key-hint {
            position: absolute; top: 5px; left: 10px; font-size: 0.8rem; color: #888;
        }

        /* 정답/오답 스타일 */
        .option-btn.correct { background-color: var(--correct-color) !important; border-color: var(--correct-color); transform: scale(1.02); }
        .option-btn.wrong { background-color: var(--wrong-color) !important; border-color: var(--wrong-color); opacity: 0.7; }

        /* 타이머 바 */
        .timer-container {
            width: 100%;
            height: 10px;
            background-color: #333;
            border-radius: 5px;
            margin-top: auto;
            overflow: hidden;
        }
        .timer-bar {
            height: 100%;
            background-color: var(--timer-bg);
            width: 100%;
            transition: width 0.1s linear;
        }

        /* 결과 테이블 및 랭킹 */
        .table-container {
            width: 100%;
            overflow-y: auto;
            max-height: 400px;
            margin-bottom: 20px;
            border: 1px solid #444;
            border-radius: 5px;
        }

        table { width: 100%; border-collapse: collapse; text-align: left; }
        th, td { padding: 12px; border-bottom: 1px solid #444; }
        th { background-color: var(--accent-color); position: sticky; top: 0; }
        tr:nth-child(even) { background-color: rgba(255,255,255,0.05); }
        
        .correct-text { color: var(--correct-color); }
        .wrong-text { color: var(--wrong-color); }
        
        .summary {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* 파일 조작 영역 */
        .file-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        /* 반응형 (모바일) */
        @media (max-width: 600px) {
            .options-grid { grid-template-columns: 1fr; }
            h1 { font-size: 2rem; }
            #word-display { font-size: 2rem; }
        }
    </style>
</head>
<body>

    <!-- 오디오 요소 (무료 효과음 링크 사용) -->
    <!-- 참고: 인터넷 연결 필요. 실제 서비스 시 로컬 파일로 대체 권장 -->
    <audio id="bgm" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_c8c8a73467.mp3?filename=cyberpunk-city-110278.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-correct">
        <source src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_bb630cc098.mp3?filename=success-1-6297.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-wrong">
        <source src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3?filename=negative-beeps-6008.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-tick">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-game-ball-tap-2073.mp3" type="audio/mpeg">
    </audio>

    <!-- 1. 메인 메뉴 -->
    <div id="main-menu" class="screen active">
        <h1>SPEED MEMORY</h1>
        <button class="btn" onclick="goToSetup()">게임 시작</button>
        <button class="btn" onclick="goToRanking()">랭킹 조회</button>
        <button class="btn" onclick="goToSettings()">설정</button>
    </div>

    <!-- 2. 설정 화면 -->
    <div id="settings-screen" class="screen">
        <h2>설정</h2>
        <div class="form-group">
            <div class="slider-container">
                <label>배경 음악 (BGM)</label>
                <input type="range" id="bgm-vol" min="0" max="1" step="0.1" value="0.5" oninput="updateVolume()">
            </div>
            <div class="slider-container">
                <label>효과음 (SFX)</label>
                <input type="range" id="sfx-vol" min="0" max="1" step="0.1" value="0.8" oninput="updateVolume()">
            </div>
        </div>
        <button class="btn" onclick="goHome()">뒤로 가기</button>
    </div>

    <!-- 3. 게임 시작 전 세팅 (사전 세팅) -->
    <div id="setup-screen" class="screen">
        <h2>게임 세팅</h2>
        <div class="form-group">
            <label>문제 수 설정 (최대: <span id="max-q">30</span>)</label>
            <input type="number" id="q-count" value="10" min="1" max="30">
        </div>
        <div class="form-group">
            <label>제한 시간 (초)</label>
            <input type="number" id="time-limit" value="3" min="1" max="10">
        </div>
        <div class="form-group">
            <label>단어 파일 업로드 (JSON)</label>
            <input type="file" id="word-file" accept=".json" onchange="loadCustomWords(this)">
            <small style="color:#888;">* 업로드 안 할 시 기본 영단어 사용</small>
        </div>
        <div>
            <button class="btn" onclick="startGame()">START</button>
            <button class="btn btn-secondary" onclick="goHome()">취소</button>
        </div>
    </div>

    <!-- 4. 게임 진행 화면 -->
    <div id="game-screen" class="screen">
        <div style="width:100%; display:flex; justify-content:space-between; color:#888;">
            <span id="game-progress">1 / 20</span>
            <span id="time-display">0.0s</span>
        </div>
        <div id="word-display">APPLE</div>
        
        <div class="options-grid">
            <button class="option-btn" id="opt-1" onclick="checkAnswer(1)"><span class="key-hint">1</span><span class="text">사과</span></button>
            <button class="option-btn" id="opt-2" onclick="checkAnswer(2)"><span class="key-hint">2</span><span class="text">바나나</span></button>
            <button class="option-btn" id="opt-3" onclick="checkAnswer(3)"><span class="key-hint">3</span><span class="text">포도</span></button>
            <button class="option-btn" id="opt-4" onclick="checkAnswer(4)"><span class="key-hint">4</span><span class="text">오렌지</span></button>
        </div>

        <div class="timer-container">
            <div class="timer-bar" id="timer-bar"></div>
        </div>
    </div>

    <!-- 5. 결과 화면 -->
    <div id="result-screen" class="screen">
        <h2>GAME OVER</h2>
        <div class="summary">
            <div>점수: <span id="res-score" style="color:var(--highlight-color)">0</span></div>
            <div>총 시간: <span id="res-total-time">0s</span></div>
        </div>
        
        <div class="table-container">
            <table id="result-table">
                <thead>
                    <tr>
                        <th>문제</th>
                        <th>정답</th>
                        <th>결과</th>
                        <th>시간</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS로 채워짐 -->
                </tbody>
            </table>
        </div>
        <button class="btn" onclick="saveAndGoRanking()">랭킹 보러가기</button>
        <button class="btn btn-secondary" onclick="goHome()">메인으로</button>
    </div>

    <!-- 6. 랭킹 화면 -->
    <div id="ranking-screen" class="screen">
        <h2>HALL OF FAME</h2>
        <div class="file-controls">
            <button class="btn btn-small" onclick="exportRanking()">랭킹 내보내기</button>
            <button class="btn btn-small btn-secondary" onclick="document.getElementById('rank-file').click()">랭킹 불러오기</button>
            <input type="file" id="rank-file" accept=".json" style="display:none" onchange="importRanking(this)">
        </div>

        <div class="table-container">
            <table id="ranking-table">
                <thead>
                    <tr>
                        <th>순위</th>
                        <th>맞춘 개수</th>
                        <th>총 시간</th>
                        <th>평균 속도</th>
                        <th>날짜</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS로 채워짐 -->
                </tbody>
            </table>
        </div>
        <button class="btn" onclick="goHome()">메인으로</button>
    </div>

    <script>
        /* === 데이터 및 상태 관리 === */
        // 기본 단어 데이터 (30개)
        const defaultWords = {
            "Apple": "사과", "Banana": "바나나", "Computer": "컴퓨터", "Desk": "책상", "Elephant": "코끼리",
            "Flower": "꽃", "Guitar": "기타", "House": "집", "Ice cream": "아이스크림", "Jungle": "정글",
            "Kangaroo": "캥거루", "Lemon": "레몬", "Money": "돈", "Notebook": "공책", "Orange": "오렌지",
            "Piano": "피아노", "Queen": "여왕", "Rabbit": "토끼", "Sun": "태양", "Tree": "나무",
            "Umbrella": "우산", "Violin": "바이올린", "Water": "물", "Xylophone": "실로폰", "Yacht": "요트",
            "Zebra": "얼룩말", "Book": "책", "School": "학교", "Teacher": "선생님", "Student": "학생"
        };

        let currentWords = {}; // 현재 게임에 사용할 전체 단어 풀
        let gameQueue = [];    // 출제될 문제 배열
        let rankingData = [];  // 랭킹 데이터

        // 게임 상태 변수
        let currentQIndex = 0;
        let correctCount = 0;
        let timeLimitPerQ = 3;
        let qCountSetting = 10;
        
        let timerInterval = null;
        let startTime = 0;
        let questionStartTime = 0;
        let gameHistory = []; // 이번 판 기록 {word, answer, isCorrect, timeTaken, correctMeaning}

        let isLocked = false; // 정답 처리 중 입력 방지

        /* === 초기화 및 오디오 설정 === */
        const bgm = document.getElementById('bgm');
        const sfxCorrect = document.getElementById('sfx-correct');
        const sfxWrong = document.getElementById('sfx-wrong');
        const sfxTick = document.getElementById('sfx-tick');

        function updateVolume() {
            bgm.volume = document.getElementById('bgm-vol').value;
            const sfxVol = document.getElementById('sfx-vol').value;
            sfxCorrect.volume = sfxVol;
            sfxWrong.volume = sfxVol;
            sfxTick.volume = sfxVol;
        }

        /* === 화면 전환 함수 === */
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function goHome() {
            stopGame();
            showScreen('main-menu');
        }

        function goToSettings() { showScreen('settings-screen'); }
        function goToRanking() { 
            renderRanking();
            showScreen('ranking-screen'); 
        }

        function goToSetup() {
            // 기본값 설정
            if (Object.keys(currentWords).length === 0) {
                currentWords = { ...defaultWords };
            }
            document.getElementById('max-q').innerText = Object.keys(currentWords).length;
            document.getElementById('q-count').max = Object.keys(currentWords).length;
            showScreen('setup-screen');
        }

        /* === 파일 처리 (JSON) === */
        function loadCustomWords(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    // 유효성 검사: 객체여야 함
                    if (typeof json === 'object' && json !== null) {
                        currentWords = json;
                        const count = Object.keys(currentWords).length;
                        document.getElementById('max-q').innerText = count;
                        
                        const qInput = document.getElementById('q-count');
                        qInput.max = count;
                        if(parseInt(qInput.value) > count) qInput.value = count;
                        
                        alert(`단어 파일 로드 성공! 총 ${count}개의 단어가 있습니다.`);
                    } else {
                        throw new Error("Invalid Format");
                    }
                } catch (err) {
                    alert("잘못된 JSON 파일입니다. 키:값 형태의 객체여야 합니다.");
                    currentWords = { ...defaultWords };
                }
            };
            reader.readAsText(file);
        }

        /* === 게임 로직 === */
        function startGame() {
            // 설정 값 가져오기
            qCountSetting = parseInt(document.getElementById('q-count').value);
            timeLimitPerQ = parseInt(document.getElementById('time-limit').value);
            
            // 문제 생성
            const keys = Object.keys(currentWords);
            // 셔플
            keys.sort(() => Math.random() - 0.5);
            // 문제 수만큼 자르기
            const selectedKeys = keys.slice(0, qCountSetting);
            
            gameQueue = selectedKeys.map(key => ({
                word: key,
                meaning: currentWords[key]
            }));

            // 초기화
            currentQIndex = 0;
            correctCount = 0;
            gameHistory = [];
            
            // BGM 재생
            bgm.currentTime = 0;
            bgm.play().catch(e => console.log("Audio play blocked")); // 자동 재생 정책 대응

            showScreen('game-screen');
            loadQuestion();
        }

        function stopGame() {
            clearInterval(timerInterval);
            bgm.pause();
        }

        function loadQuestion() {
            if (currentQIndex >= gameQueue.length) {
                finishGame();
                return;
            }

            isLocked = false;
            const currentData = gameQueue[currentQIndex];
            
            // UI 업데이트
            document.getElementById('game-progress').innerText = `${currentQIndex + 1} / ${gameQueue.length}`;
            document.getElementById('word-display').innerText = currentData.word;
            document.getElementById('time-display').innerText = `${timeLimitPerQ}.0s`;
            
            // 보기 생성 (정답 1개 + 오답 3개)
            const allMeanings = Object.values(currentWords);
            const wrongMeanings = allMeanings.filter(m => m !== currentData.meaning);
            // 오답 셔플 후 3개 선택
            wrongMeanings.sort(() => Math.random() - 0.5);
            const choices = [currentData.meaning, ...wrongMeanings.slice(0, 3)];
            // 보기 셔플
            choices.sort(() => Math.random() - 0.5);

            // 버튼 렌더링
            for(let i=1; i<=4; i++) {
                const btn = document.getElementById(`opt-${i}`);
                const textSpan = btn.querySelector('.text');
                textSpan.innerText = choices[i-1];
                btn.className = 'option-btn'; // 클래스 초기화
                
                // 데이터셋에 정답 여부 저장
                if (choices[i-1] === currentData.meaning) {
                    btn.dataset.correct = "true";
                } else {
                    btn.dataset.correct = "false";
                }
            }

            // 타이머 시작
            startTimer();
        }

        function startTimer() {
            const timerBar = document.getElementById('timer-bar');
            let timeLeft = timeLimitPerQ;
            questionStartTime = Date.now();
            
            timerBar.style.width = '100%';
            timerBar.style.transition = 'none'; // 리셋 시 애니메이션 제거
            
            // 강제 리플로우
            void timerBar.offsetWidth;

            timerBar.style.transition = `width ${timeLimitPerQ}s linear`;
            timerBar.style.width = '0%';

            clearInterval(timerInterval);
            
            // 화면 숫자 갱신용 인터벌
            timerInterval = setInterval(() => {
                const now = Date.now();
                const elapsed = (now - questionStartTime) / 1000;
                const remaining = Math.max(0, timeLimitPerQ - elapsed);
                
                document.getElementById('time-display').innerText = remaining.toFixed(1) + 's';

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    handleTimeOut();
                }
            }, 100);
        }

        function checkAnswer(userChoiceIndex) {
            if (isLocked) return;
            isLocked = true;
            clearInterval(timerInterval);

            const btn = document.getElementById(`opt-${userChoiceIndex}`);
            const isCorrect = btn.dataset.correct === "true";
            const timeTaken = (Date.now() - questionStartTime) / 1000;
            const currentData = gameQueue[currentQIndex];

            // 기록 저장
            gameHistory.push({
                word: currentData.word,
                userAnswer: btn.querySelector('.text').innerText,
                correctMeaning: currentData.meaning,
                isCorrect: isCorrect,
                timeTaken: timeTaken,
                resultType: isCorrect ? 'O' : 'X'
            });

            if (isCorrect) {
                correctCount++;
                btn.classList.add('correct');
                sfxCorrect.currentTime = 0;
                sfxCorrect.play();
            } else {
                btn.classList.add('wrong');
                highlightCorrectAnswer();
                sfxWrong.currentTime = 0;
                sfxWrong.play();
            }

            setTimeout(nextQuestion, 2000); // 2초 대기
        }

        function handleTimeOut() {
            if (isLocked) return;
            isLocked = true;
            
            const currentData = gameQueue[currentQIndex];
            
            // 기록 저장 (시간 초과)
            gameHistory.push({
                word: currentData.word,
                userAnswer: "(시간초과)",
                correctMeaning: currentData.meaning,
                isCorrect: false,
                timeTaken: timeLimitPerQ,
                resultType: 'TIME'
            });

            highlightCorrectAnswer();
            sfxWrong.currentTime = 0;
            sfxWrong.play();

            setTimeout(nextQuestion, 2000);
        }

        function highlightCorrectAnswer() {
            for(let i=1; i<=4; i++) {
                const btn = document.getElementById(`opt-${i}`);
                if (btn.dataset.correct === "true") {
                    btn.classList.add('correct');
                }
            }
        }

        function nextQuestion() {
            currentQIndex++;
            loadQuestion();
        }

        /* === 키보드 이벤트 === */
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('game-screen').classList.contains('active')) {
                if (['1', '2', '3', '4'].includes(e.key)) {
                    checkAnswer(parseInt(e.key));
                }
            }
        });

        /* === 결과 처리 === */
        function finishGame() {
            stopGame();
            showScreen('result-screen');
            
            // 요약 표시
            document.getElementById('res-score').innerText = `${correctCount} / ${gameQueue.length}`;
            
            const totalTime = gameHistory.reduce((acc, curr) => acc + curr.timeTaken, 0);
            document.getElementById('res-total-time').innerText = totalTime.toFixed(2) + 's';

            // 테이블 렌더링
            const tbody = document.querySelector('#result-table tbody');
            tbody.innerHTML = '';
            
            gameHistory.forEach(record => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${record.word}</td>
                    <td>${record.correctMeaning}</td>
                    <td class="${record.isCorrect ? 'correct-text' : 'wrong-text'}">
                        ${record.isCorrect ? '정답' : (record.resultType === 'TIME' ? '시간초과' : '오답')}
                    </td>
                    <td>${record.timeTaken.toFixed(2)}s</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function saveAndGoRanking() {
            // 현재 기록을 랭킹에 추가
            const totalTime = gameHistory.reduce((acc, curr) => acc + curr.timeTaken, 0);
            const avgTime = totalTime / gameHistory.length;
            
            const record = {
                score: correctCount,
                totalQ: gameHistory.length,
                totalTime: totalTime,
                avgTime: avgTime,
                date: new Date().toLocaleString()
            };
            
            rankingData.push(record);
            goToRanking();
        }

        /* === 랭킹 시스템 === */
        function renderRanking() {
            const tbody = document.querySelector('#ranking-table tbody');
            tbody.innerHTML = '';

            // 정렬: 맞춘 개수(내림차순) -> 총 시간(오름차순)
            rankingData.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return a.totalTime - b.totalTime;
            });

            rankingData.forEach((rank, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${rank.score} / ${rank.totalQ}</td>
                    <td>${rank.totalTime.toFixed(2)}s</td>
                    <td>${rank.avgTime.toFixed(2)}s</td>
                    <td style="font-size:0.8rem">${rank.date}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function exportRanking() {
            if (rankingData.length === 0) {
                alert("내보낼 랭킹 데이터가 없습니다.");
                return;
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(rankingData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "ranking_data.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importRanking(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        rankingData = json; // 덮어쓰기 or 합치기? 요구사항상 '불러들일 수 있도록' 이므로 덮어쓰거나 합치는 것. 여기선 합치기로 구현.
                        // 만약 완전 교체를 원하면 rankingData = json;
                        // 여기선 기존 데이터 + 불러온 데이터 합침
                        // rankingData = rankingData.concat(json); 
                        // -> 요구사항: "컴퓨터에 있는 데이터를 게임 속에 불러들임" -> 보통 로드(Load)는 덮어쓰기 개념이 강함.
                        rankingData = json;
                        
                        alert("랭킹 데이터를 성공적으로 불러왔습니다.");
                        renderRanking();
                    } else {
                        throw new Error("Not an array");
                    }
                } catch (err) {
                    alert("올바르지 않은 랭킹 파일입니다.");
                }
            };
            reader.readAsText(file);
        }

        // 초기 볼륨 설정
        updateVolume();

    </script>
</body>
</html>


